# /etc/sudoers.d/phpborg-workers
# Permissions for web user (www-data/phpborg) to manage phpBorg worker services
# Installation: sudo cp docs/sudoers-phpborg-workers /etc/sudoers.d/phpborg-workers
#               sudo chmod 440 /etc/sudoers.d/phpborg-workers

# Allow phpborg user to manage scheduler service
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-scheduler
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-scheduler --no-pager
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-scheduler --no-pager -l
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-scheduler
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-scheduler
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-scheduler
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-active phpborg-scheduler
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-enabled phpborg-scheduler

# Allow phpborg user to manage worker pool instances (with @1, @2, @3, @4)
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-worker@*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-worker@* --no-pager
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-worker@* --no-pager -l
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-worker@*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-worker@*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-worker@*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-active phpborg-worker@*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-enabled phpborg-worker@*

# Allow phpborg user to read logs via journalctl
phpborg ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-scheduler --no-pager -n *
phpborg ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-scheduler --no-pager --since *
phpborg ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-worker@* --no-pager -n *
phpborg ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-worker@* --no-pager --since *

# Allow phpborg user to list all phpborg services
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl list-units phpborg-* --no-pager

# If your web server runs as www-data, also add these lines:
www-data ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-scheduler
www-data ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-scheduler --no-pager
www-data ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-scheduler --no-pager -l
www-data ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-scheduler
www-data ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-scheduler
www-data ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-scheduler
www-data ALL=(ALL) NOPASSWD: /bin/systemctl is-active phpborg-scheduler
www-data ALL=(ALL) NOPASSWD: /bin/systemctl is-enabled phpborg-scheduler

www-data ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-worker@*
www-data ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-worker@* --no-pager
www-data ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-worker@* --no-pager -l
www-data ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-worker@*
www-data ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-worker@*
www-data ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-worker@*
www-data ALL=(ALL) NOPASSWD: /bin/systemctl is-active phpborg-worker@*
www-data ALL=(ALL) NOPASSWD: /bin/systemctl is-enabled phpborg-worker@*

www-data ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-scheduler --no-pager -n *
www-data ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-scheduler --no-pager --since *
www-data ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-worker@* --no-pager -n *
www-data ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-worker@* --no-pager --since *

www-data ALL=(ALL) NOPASSWD: /bin/systemctl list-units phpborg-* --no-pager

# ========================================================================
# Instant Recovery Permissions (for remote backup servers)
# ========================================================================
# These permissions should be added on REMOTE backup servers to allow
# the backup user (used by SSH) to perform instant recovery operations.
# Instant Recovery mounts Borg archives with OverlayFS and starts
# ephemeral database instances for testing/querying without full restore.
#
# To deploy on remote server:
#   1. Create file /etc/sudoers.d/phpborg-instant-recovery
#   2. Add the permissions below for your backup user
#   3. sudo chmod 440 /etc/sudoers.d/phpborg-instant-recovery
#
# Replace 'backup_user' with your actual SSH backup user (often 'root' or 'phpborg')
# ========================================================================

# Allow backup user to create mount directories
# backup_user ALL=(ALL) NOPASSWD: /bin/mkdir -p /tmp/phpborg_instant_recovery/*

# Allow backup user to mount/unmount Borg archives via FUSE
# backup_user ALL=(ALL) NOPASSWD: /usr/bin/borg mount * /tmp/phpborg_instant_recovery/*
# backup_user ALL=(ALL) NOPASSWD: /usr/bin/borg umount /tmp/phpborg_instant_recovery/*

# Allow backup user to mount/unmount OverlayFS (required for RW layer on RO backup)
# backup_user ALL=(ALL) NOPASSWD: /bin/mount -t overlay overlay -o lowerdir=*,upperdir=/tmp/phpborg_instant_recovery/*,workdir=/tmp/phpborg_instant_recovery/* /tmp/phpborg_instant_recovery/*
# backup_user ALL=(ALL) NOPASSWD: /bin/umount /tmp/phpborg_instant_recovery/*
# backup_user ALL=(ALL) NOPASSWD: /bin/umount -f /tmp/phpborg_instant_recovery/*

# Allow backup user to switch to postgres user for starting/stopping PostgreSQL instances
# backup_user ALL=(postgres) NOPASSWD: /usr/lib/postgresql/*/bin/pg_ctl *
# backup_user ALL=(postgres) NOPASSWD: /usr/bin/pg_ctl *

# Allow backup user to switch to mysql user for MySQL instances (future)
# backup_user ALL=(mysql) NOPASSWD: /usr/bin/mysqld_safe *
# backup_user ALL=(mysql) NOPASSWD: /usr/sbin/mysqld *

# Allow backup user to check processes and kill database instances
# backup_user ALL=(ALL) NOPASSWD: /bin/ps aux
# backup_user ALL=(ALL) NOPASSWD: /usr/bin/head -1 /tmp/phpborg_instant_recovery/*/postmaster.pid
# backup_user ALL=(ALL) NOPASSWD: /bin/kill *
# backup_user ALL=(ALL) NOPASSWD: /usr/bin/pkill -f phpborg_instant*

# Allow backup user to cleanup temporary instant recovery directories
# backup_user ALL=(ALL) NOPASSWD: /bin/rm -rf /tmp/phpborg_instant_recovery/*
# backup_user ALL=(ALL) NOPASSWD: /bin/chmod * /tmp/phpborg_instant_recovery/*

# Allow backup user to check mounts
# backup_user ALL=(ALL) NOPASSWD: /bin/mount
# backup_user ALL=(ALL) NOPASSWD: /usr/bin/grep /tmp/phpborg_instant_recovery

# Example for root user (if SSH as root - simpler approach):
# root ALL=(postgres) NOPASSWD: ALL
# root ALL=(mysql) NOPASSWD: ALL

# ========================================================================
# Borg Operations as phpborg-borg
# ========================================================================
# All local Borg repositories are owned by phpborg-borg:phpborg-borg
# Workers run as phpborg but need to access repos via sudo

# Allow phpborg to run all borg commands as phpborg-borg with env vars
phpborg ALL=(phpborg-borg) NOPASSWD: SETENV: /usr/bin/borg *

# Mount directories for borg archive browsing
phpborg ALL=(phpborg-borg) NOPASSWD: /bin/mkdir -p /var/lib/phpborg/mounts/*
phpborg ALL=(phpborg-borg) NOPASSWD: /bin/rmdir /var/lib/phpborg/mounts/*
phpborg ALL=(ALL) NOPASSWD: /bin/rm -rf /var/lib/phpborg/mounts/*
