# Règles sudo pour le worker agent phpBorg
# Permet à l'utilisateur phpborg d'effectuer des opérations limitées
# sur les fichiers appartenant à phpborg-borg

# Commandes autorisées SANS mot de passe
# ATTENTION: Limitées strictement aux opérations nécessaires

# Gestion des répertoires de backup
phpborg ALL=(root) NOPASSWD: /bin/mkdir -p /opt/backups/*
phpborg ALL=(root) NOPASSWD: /bin/chown phpborg-borg\:phpborg-borg /opt/backups/*
phpborg ALL=(root) NOPASSWD: /bin/chmod 750 /opt/backups/*

# Gestion du répertoire SSH de phpborg-borg
phpborg ALL=(root) NOPASSWD: /bin/mkdir -p /var/lib/phpborg-borg/.ssh
phpborg ALL=(root) NOPASSWD: /bin/chown phpborg-borg\:phpborg-borg /var/lib/phpborg-borg/.ssh
phpborg ALL=(root) NOPASSWD: /bin/chmod 700 /var/lib/phpborg-borg/.ssh

# Gestion du fichier authorized_keys
phpborg ALL=(root) NOPASSWD: /bin/touch /var/lib/phpborg-borg/.ssh/authorized_keys
phpborg ALL=(root) NOPASSWD: /bin/cat /var/lib/phpborg-borg/.ssh/authorized_keys
phpborg ALL=(root) NOPASSWD: /bin/cp /tmp/phpborg_authorized_keys_* /var/lib/phpborg-borg/.ssh/authorized_keys
phpborg ALL=(root) NOPASSWD: /bin/chown phpborg-borg\:phpborg-borg /var/lib/phpborg-borg/.ssh/authorized_keys
phpborg ALL=(root) NOPASSWD: /bin/chmod 600 /var/lib/phpborg-borg/.ssh/authorized_keys

# Lecture du répertoire (pour vérification)
phpborg ALL=(root) NOPASSWD: /bin/ls /var/lib/phpborg-borg
phpborg ALL=(root) NOPASSWD: /bin/ls /var/lib/phpborg-borg/.ssh
phpborg ALL=(root) NOPASSWD: /bin/ls /opt/backups
phpborg ALL=(root) NOPASSWD: /bin/ls /opt/backups/*
