# phpBorg Workers - Systemd Service Management
# Allows phpborg user to manage worker services via web interface
# This file is auto-updated by phpBorg during updates

# Status checks (read-only)
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-active phpborg-*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-enabled phpborg-*

# Service management (start/stop/restart)
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-scheduler
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-scheduler
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-scheduler

phpborg ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-worker@*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-worker@*
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-worker@*

phpborg ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-workers.target
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-workers.target
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-workers.target

# Log viewing
phpborg ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-* -n * --since * --output *
phpborg ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-* -n *
phpborg ALL=(ALL) NOPASSWD: /bin/journalctl -u phpborg-*

# Reload systemd daemon
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl daemon-reload

# Regenerate systemd services (for updates)
phpborg ALL=(ALL) NOPASSWD: /opt/newphpborg/phpBorg/bin/regenerate-systemd-services.sh

# Restart services script (for updates)
phpborg ALL=(ALL) NOPASSWD: /bin/bash /opt/newphpborg/phpBorg/bin/restart-services.sh

# Agent SSH key management (for AgentManager)
phpborg ALL=(ALL) NOPASSWD: /bin/tee -a /var/lib/phpborg-borg/.ssh/authorized_keys
phpborg ALL=(ALL) NOPASSWD: /bin/cp * /var/lib/phpborg-borg/.ssh/authorized_keys
phpborg ALL=(ALL) NOPASSWD: /bin/chown phpborg-borg\:phpborg-borg /var/lib/phpborg-borg/.ssh/authorized_keys
phpborg ALL=(ALL) NOPASSWD: /bin/chmod 600 /var/lib/phpborg-borg/.ssh/authorized_keys

# Agent backup directory preparation (validates against storage pools)
phpborg ALL=(ALL) NOPASSWD: /opt/newphpborg/phpBorg/bin/prepare-backup-directory.sh *

# Borg init as phpborg-borg (for agent backups) - SETENV allows BORG_PASSPHRASE
phpborg ALL=(phpborg-borg) NOPASSWD: SETENV: /usr/bin/borg *

# Borg SSH server management
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl status phpborg-sshd
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl start phpborg-sshd
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl stop phpborg-sshd
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl restart phpborg-sshd

# SSL/TLS Certificate Management
phpborg ALL=(ALL) NOPASSWD: /usr/sbin/nginx -t
phpborg ALL=(ALL) NOPASSWD: /usr/sbin/nginx -t -c *
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl reload nginx
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-active nginx
phpborg ALL=(ALL) NOPASSWD: /bin/systemctl is-active certbot.timer
phpborg ALL=(ALL) NOPASSWD: /usr/bin/certbot certonly *
phpborg ALL=(ALL) NOPASSWD: /usr/bin/certbot renew *
phpborg ALL=(ALL) NOPASSWD: /usr/bin/certbot certificates *

# SSL file management (certificates and nginx config)
phpborg ALL=(ALL) NOPASSWD: /bin/mkdir -p /etc/phpborg/ssl*
phpborg ALL=(ALL) NOPASSWD: /bin/cp * /etc/phpborg/ssl/*
phpborg ALL=(ALL) NOPASSWD: /bin/cp * /etc/nginx/sites-available/phpborg*
phpborg ALL=(ALL) NOPASSWD: /bin/chmod * /etc/phpborg/ssl*
phpborg ALL=(ALL) NOPASSWD: /bin/ln -s /etc/nginx/sites-available/phpborg /etc/nginx/sites-enabled/phpborg

# Mount directories for borg archive browsing
phpborg ALL=(phpborg-borg) NOPASSWD: /bin/mkdir -p /var/lib/phpborg/mounts/*
phpborg ALL=(phpborg-borg) NOPASSWD: /bin/rmdir /var/lib/phpborg/mounts/*
phpborg ALL=(ALL) NOPASSWD: /bin/rm -rf /var/lib/phpborg/mounts/*
phpborg ALL=(ALL) NOPASSWD: /bin/umount -l /var/lib/phpborg/mounts/*

# Instant Recovery - mount/unmount operations
phpborg ALL=(ALL) NOPASSWD: /bin/mkdir -p /tmp/phpborg_*
phpborg ALL=(ALL) NOPASSWD: /bin/rm -rf /tmp/phpborg_*
phpborg ALL=(ALL) NOPASSWD: /bin/umount /tmp/phpborg_*
phpborg ALL=(ALL) NOPASSWD: /bin/umount -l /tmp/phpborg_*
phpborg ALL=(ALL) NOPASSWD: /usr/bin/fusermount -u /tmp/phpborg_*
phpborg ALL=(ALL) NOPASSWD: /bin/chown -R * /tmp/phpborg_*
phpborg ALL=(ALL) NOPASSWD: /bin/chmod -R * /tmp/phpborg_*
