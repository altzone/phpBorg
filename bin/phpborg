#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * phpBorg - Professional PHP 8.3+ frontend for BorgBackup
 *
 * @license GPL-3.0-or-later
 */

// Load Composer autoloader
$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
];

$autoloaded = false;
foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        $autoloaded = true;
        break;
    }
}

if (!$autoloaded) {
    fwrite(STDERR, "Error: Composer autoloader not found.\n");
    fwrite(STDERR, "Please run: composer install\n");
    exit(1);
}

use PhpBorg\Application;
use PhpBorg\Command\AddServerCommand;
use PhpBorg\Command\BackupCommand;
use PhpBorg\Command\DatabaseAddCommand;
use PhpBorg\Command\FullBackupCommand;
use PhpBorg\Command\InfoCommand;
use PhpBorg\Command\ListCommand;
use PhpBorg\Command\ListServersCommand;
use PhpBorg\Command\MountCommand;
use PhpBorg\Command\PruneCommand;
use PhpBorg\Command\SetupCommand;
use Symfony\Component\Console\Application as ConsoleApplication;

// Check PHP version
if (PHP_VERSION_ID < 80300) {
    fwrite(STDERR, sprintf(
        "Error: phpBorg requires PHP 8.3 or higher. You are running PHP %s.\n",
        PHP_VERSION
    ));
    exit(1);
}

// Check if running setup command (which can run without full initialization)
$isSetupCommand = isset($argv[1]) && $argv[1] === 'setup';

try {
    // Create console application
    $console = new ConsoleApplication('phpBorg', '2.0.0');
    $console->setCatchExceptions(true);

    // Try to initialize Application (may fail if .env doesn't exist)
    $app = null;
    try {
        $app = new Application();
    } catch (\PhpBorg\Exception\ConfigurationException $e) {
        if (!$isSetupCommand) {
            // If not running setup, this is a fatal error
            fwrite(STDERR, "Configuration Error: {$e->getMessage()}\n");
            fwrite(STDERR, "Please run 'phpborg setup' to configure the application.\n");
            exit(1);
        }
        // Otherwise, continue with null $app for setup command
    }

    // Always register setup command (works with or without initialized app)
    $console->add(new SetupCommand($app));

    // Register other commands only if app is initialized
    if ($app !== null) {
        // Backup commands
        $console->add(new BackupCommand($app));
        $console->add(new FullBackupCommand($app));
        $console->add(new PruneCommand($app));

        // Server commands
        $console->add(new AddServerCommand($app));
        $console->add(new ListServersCommand($app));

        // Archive commands
        $console->add(new ListCommand($app));
        $console->add(new MountCommand($app));
        $console->add(new InfoCommand($app));

        // Database commands
        $console->add(new DatabaseAddCommand($app));
    }

    // Run console application
    $exitCode = $console->run();

    // Cleanup
    if ($app !== null) {
        $app->shutdown();
    }

    exit($exitCode);
} catch (\PhpBorg\Exception\DatabaseException $e) {
    fwrite(STDERR, "Database Error: {$e->getMessage()}\n");
    fwrite(STDERR, "Please check your database configuration or run 'phpborg setup --fix'.\n");
    exit(1);
} catch (\Throwable $e) {
    fwrite(STDERR, "Fatal Error: {$e->getMessage()}\n");
    if (isset($app) && $app !== null && $app->getConfig()->isDebug()) {
        fwrite(STDERR, $e->getTraceAsString() . "\n");
    }
    exit(1);
}
