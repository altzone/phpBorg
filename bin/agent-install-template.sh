#!/bin/bash
# phpBorg Agent Installer
# This script is generated by phpBorg and customized for each agent

set -e

# Configuration (replaced during generation)
AGENT_NAME="__AGENT_NAME__"
AGENT_UUID="__AGENT_UUID__"
SERVER_URL="__SERVER_URL__"
BORG_SSH_PORT="__BORG_SSH_PORT__"

# Paths
AGENT_USER="phpborg-agent"
AGENT_HOME="/var/lib/phpborg-agent"
CONFIG_DIR="/etc/phpborg-agent"
LOG_DIR="/var/log/phpborg-agent"
BIN_DIR="$AGENT_HOME/bin"
BIN_PATH="$BIN_DIR/phpborg-agent"

echo "=================================="
echo "phpBorg Agent Installer"
echo "=================================="
echo ""
echo "Agent Name: $AGENT_NAME"
echo "Agent UUID: $AGENT_UUID"
echo "Server URL: $SERVER_URL"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: Please run as root"
    exit 1
fi

# Detect OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    OS_VERSION=$VERSION_ID
else
    OS="unknown"
fi

echo "Detected OS: $OS $OS_VERSION"

# Step 1: Create phpborg-agent user
echo ""
echo "[1/7] Creating phpborg-agent user..."
if id "$AGENT_USER" &>/dev/null; then
    echo "  User $AGENT_USER already exists"
else
    useradd --system \
        --home-dir "$AGENT_HOME" \
        --create-home \
        --shell /usr/sbin/nologin \
        --comment "phpBorg Agent" \
        "$AGENT_USER"
    echo "  User created"
fi

# Step 2: Create directories
echo ""
echo "[2/7] Creating directories..."
mkdir -p "$CONFIG_DIR"
mkdir -p "$LOG_DIR"
mkdir -p "$AGENT_HOME/.ssh"
mkdir -p "$BIN_DIR"
chmod 700 "$AGENT_HOME/.ssh"
chown -R "$AGENT_USER:$AGENT_USER" "$AGENT_HOME"
chown -R "$AGENT_USER:$AGENT_USER" "$LOG_DIR"
echo "  Directories created"

# Step 3: Generate SSH key pair (Ed25519)
echo ""
echo "[3/7] Generating SSH key pair..."
SSH_KEY_PATH="$AGENT_HOME/.ssh/id_ed25519"
if [ -f "$SSH_KEY_PATH" ]; then
    echo "  SSH key already exists"
else
    ssh-keygen -t ed25519 \
        -f "$SSH_KEY_PATH" \
        -N "" \
        -C "phpborg-agent-$AGENT_UUID"
    chown "$AGENT_USER:$AGENT_USER" "$SSH_KEY_PATH" "$SSH_KEY_PATH.pub"
    chmod 600 "$SSH_KEY_PATH"
    chmod 644 "$SSH_KEY_PATH.pub"
    echo "  SSH key generated"
fi

SSH_PUBLIC_KEY=$(cat "$SSH_KEY_PATH.pub")

# Step 4: Install BorgBackup if not present
echo ""
echo "[4/7] Installing BorgBackup..."
if command -v borg &>/dev/null; then
    BORG_VERSION=$(borg --version)
    echo "  BorgBackup already installed: $BORG_VERSION"
else
    case $OS in
        ubuntu|debian)
            apt-get update -qq
            apt-get install -y -qq borgbackup
            ;;
        centos|rhel|fedora|rocky|alma)
            if command -v dnf &>/dev/null; then
                dnf install -y borgbackup
            else
                yum install -y epel-release
                yum install -y borgbackup
            fi
            ;;
        *)
            echo "  WARNING: Unknown OS, downloading borg binary..."
            wget -q -O /usr/local/bin/borg \
                "https://github.com/borgbackup/borg/releases/download/1.2.7/borg-linux64"
            chmod +x /usr/local/bin/borg
            ;;
    esac
    BORG_VERSION=$(borg --version)
    echo "  Installed: $BORG_VERSION"
fi

# Step 5: Install sudoers rules
echo ""
echo "[5/7] Installing sudoers rules..."
SUDOERS_FILE="/etc/sudoers.d/phpborg-agent"
cat > "$SUDOERS_FILE" << 'SUDOERS_EOF'
# phpBorg Agent sudoers rules
# Minimal privileges for backup operations

Defaults:phpborg-agent !requiretty
Defaults:phpborg-agent env_reset

# System information (read-only)
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/cat /etc/*
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/cat /proc/*
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/df *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/du *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/find *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/which *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/systemctl is-active *

# MySQL/MariaDB (read-only dumps)
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/mysqldump *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/mariadb-dump *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/mysql -e *

# PostgreSQL (read-only dumps)
phpborg-agent ALL=(postgres) NOPASSWD: /usr/bin/pg_dump *
phpborg-agent ALL=(postgres) NOPASSWD: /usr/bin/pg_dumpall *
phpborg-agent ALL=(postgres) NOPASSWD: /usr/bin/psql -t -c *

# Borg Backup
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/borg --version
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/borg create *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/borg extract *
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/borg list *

# LVM Snapshots (restricted naming pattern)
phpborg-agent ALL=(root) NOPASSWD: /usr/sbin/lvcreate -L * -s -n phpborg_snap_* *
phpborg-agent ALL=(root) NOPASSWD: /usr/sbin/lvremove -f /dev/*/phpborg_snap_*
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/mount -o ro /dev/*/phpborg_snap_* /mnt/phpborg_*
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/umount /mnt/phpborg_*

# Restore operations (restricted paths)
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/mkdir -p /var/restore/*
phpborg-agent ALL=(root) NOPASSWD: /usr/bin/rm -rf /var/restore/*
SUDOERS_EOF
chmod 440 "$SUDOERS_FILE"
echo "  Sudoers rules installed"

# Add to docker group if docker exists
if getent group docker > /dev/null 2>&1; then
    usermod -aG docker "$AGENT_USER" 2>/dev/null || true
    echo "  Added to docker group"
fi

# Step 6: Register with phpBorg server
echo ""
echo "[6/7] Registering with phpBorg server..."
HOSTNAME=$(hostname -f)

REGISTER_RESPONSE=$(curl -s -X POST \
    -H "Content-Type: application/json" \
    -d "{
        \"name\": \"$AGENT_NAME\",
        \"hostname\": \"$HOSTNAME\",
        \"ssh_public_key\": \"$SSH_PUBLIC_KEY\",
        \"os_info\": \"$OS $OS_VERSION\",
        \"version\": \"1.0.0\"
    }" \
    "${SERVER_URL}/api/agent/register" 2>&1) || {
    echo "  ERROR: Failed to connect to phpBorg server"
    echo "  Response: $REGISTER_RESPONSE"
    exit 1
}

# Parse response
if ! echo "$REGISTER_RESPONSE" | grep -q '"success":true'; then
    echo "  ERROR: Registration failed"
    echo "  Response: $REGISTER_RESPONSE"
    exit 1
fi

# Extract data using python if available, fallback to simple parsing
if command -v python3 &>/dev/null; then
    CERT=$(echo "$REGISTER_RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin)['data']; print(d.get('certificate',''))")
    KEY=$(echo "$REGISTER_RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin)['data']; print(d.get('private_key',''))")
    CA=$(echo "$REGISTER_RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin)['data']; print(d.get('ca_certificate',''))")
    BACKUP_PATH=$(echo "$REGISTER_RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin)['data']['borg_ssh']; print(d.get('backup_path',''))")
    SSH_USER=$(echo "$REGISTER_RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin)['data']['borg_ssh']; print(d.get('user','phpborg-borg'))")
else
    # Fallback to grep/sed (less reliable)
    CERT=""
    KEY=""
    CA=""
    BACKUP_PATH="/opt/backups/$AGENT_UUID"
    SSH_USER="phpborg-borg"
    echo "  WARNING: python3 not found, using default values"
fi

# Save certificates if we got them
if [ -n "$CERT" ] && [ -n "$KEY" ] && [ -n "$CA" ]; then
    echo -e "$CERT" > "$CONFIG_DIR/agent.crt"
    echo -e "$KEY" > "$CONFIG_DIR/agent.key"
    echo -e "$CA" > "$CONFIG_DIR/ca.crt"
    chmod 600 "$CONFIG_DIR/agent.key"
    chmod 644 "$CONFIG_DIR/agent.crt" "$CONFIG_DIR/ca.crt"
    TLS_ENABLED="true"
else
    TLS_ENABLED="false"
    echo "  WARNING: No certificates received, TLS disabled"
fi

echo "  Registered successfully"

# Step 7: Create configuration file
echo ""
echo "[7/7] Creating configuration..."

# Extract server hostname from URL
SERVER_HOST=$(echo "$SERVER_URL" | sed 's|https\?://||' | sed 's|/.*||')

cat > "$CONFIG_DIR/config.yaml" << CONFIG_EOF
# phpBorg Agent Configuration
# Generated: $(date -Iseconds)

server:
  url: ${SERVER_URL}/api
  insecure_skip_verify: false

agent:
  uuid: $AGENT_UUID
  name: $AGENT_NAME
  max_concurrent_tasks: 2

borg_ssh:
  host: $SERVER_HOST
  port: $BORG_SSH_PORT
  user: ${SSH_USER}
  private_key_path: $SSH_KEY_PATH
  backup_path: ${BACKUP_PATH}

polling:
  interval: 5s
  heartbeat_interval: 60s

logging:
  level: info
  file: $LOG_DIR/agent.log

tls:
  cert_file: $CONFIG_DIR/agent.crt
  key_file: $CONFIG_DIR/agent.key
  ca_file: $CONFIG_DIR/ca.crt
CONFIG_EOF

chown -R "$AGENT_USER:$AGENT_USER" "$CONFIG_DIR"
chmod 600 "$CONFIG_DIR/config.yaml"
echo "  Configuration created"

# Create systemd service
echo ""
echo "Creating systemd service..."
cat > /etc/systemd/system/phpborg-agent.service << SERVICE_EOF
[Unit]
Description=phpBorg Agent
Documentation=https://github.com/your-repo/phpborg
After=network.target

[Service]
Type=simple
User=$AGENT_USER
Group=$AGENT_USER
ExecStart=$BIN_PATH -config $CONFIG_DIR/config.yaml
Restart=always
RestartSec=10

# Security hardening
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=read-only
PrivateTmp=yes
ReadWritePaths=$LOG_DIR
ReadWritePaths=$AGENT_HOME

[Install]
WantedBy=multi-user.target
SERVICE_EOF

systemctl daemon-reload
echo "  Systemd service created"

echo ""
echo "=================================="
echo "Installation Complete!"
echo "=================================="
echo ""
echo "Agent UUID: $AGENT_UUID"
echo "Agent Name: $AGENT_NAME"
echo "Config:     $CONFIG_DIR/config.yaml"
echo ""
echo "Next steps:"
echo "1. Download agent binary: curl -o $BIN_PATH ${SERVER_URL}/downloads/phpborg-agent && chmod +x $BIN_PATH"
echo "2. Start the agent: systemctl start phpborg-agent"
echo "3. Enable on boot: systemctl enable phpborg-agent"
echo ""
echo "View logs: journalctl -u phpborg-agent -f"
echo ""
